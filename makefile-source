.PHONY: default build debug

_contentOf =	$(strip \
								$(filter-out .,\
								$(filter-out ..,\
									$(patsubst ./%,%,\
										$(wildcard $(1)/.*) $(wildcard $(1)/*)))))

contentOf =	$(foreach \
							path,\
							$(call _contentOf,$(1)),\
							$(if \
								$(wildcard $(path)/makefile),\
								make--$(path),\
								$(if \
									$(call _contentOf,$(path)),\
									copy--$(path),\
									$(path))))

currentSourcePath := $(shell npx shx pwd)
currentReleasePath := $(subst /source/,/release/,\
											$(subst /source,/release,\
												$(currentSourcePath)))

# sourcePath :=	$(foreach \
# 								path,\
# 								$(call contentOf,.),\
# 								$(currentSourcePath)/$(path))
# releasePath :=	$(subst /source/,/release/,$(sourcePath))

sourcePath	:=	$(call contentOf,.)
releasePath :=	$(foreach \
									path,\
									$(sourcePath),\
									$(if \
										$(findstring make--,$(path)),\
										$(path),\
										$(if \
												$(findstring copy--,$(path)),\
												$(path),\
												$(currentReleasePath)/$(path))))

# $(currentReleasePath)/$(path))

# $(if \
# 	$(findstring make/,$(path)),\
# 		$(path),\
# 		$(currentReleasePath)/$(path)))

# define runMake
# @echo done.
# endef

# export rootPath
# $(currentReleasePath)/%/makefile: %/makefile
# # @npx shx mkdir -p $(patsubst %/,%,$(dir $@))
# # @npx shx touch $@
# 	$(MAKE) --directory=$(patsubst %/,%,$(dir $<)) build

default: build

make--%: export rootPath
make--%:
	@npx shx echo $(patsubst $(rootPath)/%,%,$(currentReleasePath)/$*)
	@$(MAKE) --directory=$* build

copy--%:
	@npx shx echo $(patsubst $(rootPath)/%,%,$(currentReleasePath)/$*)
	@npx shx mkdir -p $(patsubst %/,%,$(currentReleasePath))
	@npx shx cp -R $* $(currentReleasePath)

$(currentReleasePath)/%.js: %.js
	@npx shx echo $(patsubst $(rootPath)/%,%,$@)
	@npx eslint --fix $(notdir $<)
	@npx babel $(notdir $<) --out-file $@ --source-maps

$(currentReleasePath)/%: %
	@npx shx echo $(patsubst $(rootPath)/%,%,$@)
	@npx shx mkdir -p $(patsubst %/,%,$(dir $@))
	@npx shx cp -R $(notdir $<) $@

build: $(releasePath);
	@npx shx mkdir -p $(currentReleasePath)

debug:
	@echo sourcePath = $(sourcePath)
	@echo releasePath = $(releasePath)
